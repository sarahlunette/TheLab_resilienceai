import ee

# ---- Change detection (SAR and optical)
sar_change = s1_after.subtract(s1_before).rename("sar_change")
optical_diff = (
    s2_after.select(["B4", "B3", "B2"])
    .subtract(s2_before.select(["B4", "B3", "B2"]))
    .rename(["red_diff", "green_diff", "blue_diff"])
)
ndvi_before = s2_before.normalizedDifference(["B8", "B4"]).rename("ndvi_before")
ndvi_after = s2_after.normalizedDifference(["B8", "B4"]).rename("ndvi_after")
ndvi_change = ndvi_after.subtract(ndvi_before).rename("ndvi_change")

# ---- Baseline vulnerability
dem = ee.Image("USGS/SRTMGL1_003").clip(AOI)
slope = ee.Terrain.slope(dem).rename("slope")

# You must upload/rasterize your OSM masks as GEE Assets for building_density and road_density
building_density = ee.Image("users/yourname/building_density_raster").clip(AOI)
road_density = ee.Image("users/yourname/road_density_raster").clip(AOI)
baseline_vuln = (
    (building_density.add(road_density).add(slope.divide(30)))
    .divide(3)
    .rename("baseline_vulnerability")
)

# ---- Event-driven vulnerability
event_vuln = (
    baseline_vuln.add(sar_change.abs().divide(10))
    .add(ndvi_change.abs())
    .divide(3)
    .rename("event_vulnerability")
)

# ---- Stack features
final_stack = (
    s1_before.addBands(s1_after)
    .addBands(sar_change)
    .addBands(s2_before)
    .addBands(s2_after)
    .addBands(optical_diff)
    .addBands(ndvi_before)
    .addBands(ndvi_after)
    .addBands(ndvi_change)
    .addBands(baseline_vuln)
    .addBands(event_vuln)
)
